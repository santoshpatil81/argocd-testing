apiVersion: batch/v1
kind: Job
metadata:
  generateName: conftest-
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      volumes:
        - name: conftest-code
          emptyDir: {}
        - name: git-secret
          secret:
            secretName: git-creds
            defaultMode: 0400
      initContainers:
        - image: k8s.gcr.io/git-sync:v3.6.6
          name: git-sync-sidecar
          env:
            - name: GIT_SYNC_REPO
              value: "https://github.com/open-policy-agent/conftest.git"
            - name: GIT_SYNC_BRANCH
              value: "master"
            - name: GIT_SYNC_ROOT
              value: /data
            - name: GIT_SYNC_DEST
              value: "/conftest-code"
            - name: GIT_SYNC_PERIOD
              value: "10"
            - name: GIT_SYNC_ONE_TIME
              value: "false"
            - name: GIT_SYNC_DEPTH
              value: "1"
          volumeMounts:
            - name: conftest-code
              mountPath: /conftest-code
              readOnly: false
            - name: git-secret
              mountPath: /etc/git-secret
              readOnly: true
          securityContext:
            runAsUser: 65533
      containers:
        - name: conftest
          image: alpine:latest
          command: ["/bin/sh"]
          args:
          - -c
          - >
            wget 'https://github.com/open-policy-agent/conftest/releases/download/v0.42.1/conftest_0.42.1_Linux_x86_64.tar.gz' &&
            mkdir -p /tmp/conftest &&
            tar xzf conftest_0.42.1_Linux_x86_64.tar.gz --directory /tmp/conftest &&
            ls -lah /tmp/conftest &&
            ls -lah /conftest-code &&
            /tmp/conftest/conftest test '/conftest-code/examples/kubernetes/deployment.yaml' -p /conftest-code/examples/kubernetes/policy -o json >> /tmp/out.json &&
            cat /tmp/out.json
          volumeMounts:
            - name: conftest-code
              mountPath: /conftest-code
              readOnly: true
      restartPolicy: Never
  backoffLimit: 1
