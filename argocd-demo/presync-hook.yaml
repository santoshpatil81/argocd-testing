---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitsync-exechook-script
data:
  gitsync_exechook_cmd_to_use.sh: |
    #!/bin/sh
    # this script will be executed in active path ${GIT_SYNC_ROOT}/(hash)
    # assuming it can write and erase path /dags_dest

    # unless v level of git-sync is set to 6, echo message will not be shown in docker console.

    # Empty the /dags_dest directory
    if [ "$(ls -A /dags_dest)" ]; then
        echo "/dags_dest is not empty. Removing all files and directories."
        rm -rf /dags_dest/*
    fi

    # Copy everything under the active directory to /dags_dest
    cp -R . /dags_dest/
    cp -R ./conftest-code

    echo "Files copied to /dags_dest."

---
apiVersion: batch/v1
kind: Job
metadata:
  generateName: conftest-
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      volumes:
        - name: conftest-code
          emptyDir: {}
        - name: git-secret
          secret:
            secretName: git-creds
            defaultMode: 0400
        - name: gitsync-exechook-script
          configMap:
            name: gitsync-exechook-script
            defaultMode: 0777
      initContainers:
        - image: registry.k8s.io/git-sync/git-sync:v3.6.5
          name: git-sync-sidecar
          args:
            - "-repo=https://github.com/open-policy-agent/conftest.git"
            - "-branch=master"
            - "-depth=1"
            - "-max-sync-failures=1"
            - "-root=/tmp/gitdata"
            - "-dest=/dags_dest/dest"
            - "-wait=60"
            - "-v=5"
            - "-one-time"
            - "-exechook-command=/tmp/gitsync_exechook_cmd_to_use.sh"
          volumeMounts:
            - name: conftest-code
              mountPath: /dags_dest
              readOnly: false
            - name: git-secret
              mountPath: /etc/git-secret
              readOnly: true
            - name: gitsync-exechook-script
              mountPath: /tmp/gitsync_exechook_cmd_to_use.sh
              subPath: gitsync_exechook_cmd_to_use.sh
          securityContext:
            runAsUser: 65534
      containers:
        - name: conftest
          image: alpine:latest
          command: ["/bin/sh"]
          args:
          - -c
          - >
            wget 'https://github.com/open-policy-agent/conftest/releases/download/v0.42.1/conftest_0.42.1_Linux_x86_64.tar.gz' &&
            mkdir -p /tmp/conftest &&
            tar xzf conftest_0.42.1_Linux_x86_64.tar.gz --directory /tmp/conftest &&
            echo "+++++++++++++++++++" &&
            ls -lah /tmp/conftest &&
            echo "+++++++++++++++++++" &&
            ls -lah /conftest-code &&
            echo "+++++++++++++++++++" &&
            ls -lahr /conftest-code/repo &&
            echo "+++++++++++++++++++" &&
            ls -lahr /tmp/data &&
            /tmp/conftest/conftest test '/conftest-code/examples/kubernetes/deployment.yaml' -p /conftest-code/examples/kubernetes/policy -o json >> /tmp/out.json &&
            cat /tmp/out.json
          volumeMounts:
            - name: conftest-code
              mountPath: /conftest-code
              readOnly: true
      restartPolicy: Never
  backoffLimit: 1
